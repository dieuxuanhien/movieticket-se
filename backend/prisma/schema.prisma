// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

}
// ====================== ENUMS ======================
enum UserRole {
  ADMIN
  MANAGER
  STAFF
  USER
}
enum BookingStatus {
  PENDING    // Booking created, waiting for payment
  CONFIRMED  // Payment successful
  CANCELLED  // Cancelled by user or system
  EXPIRED    // Payment timeout
}
enum PaymentStatus {
  PENDING     // Payment initiated
  PROCESSING  // Payment is being processed
  COMPLETED   // Payment successful
  FAILED      // Payment failed
  REFUNDED    // Payment refunded
}
enum PaymentMethod {
  VNPAY
  CREDIT_CARD
  MOMO
  ZALOPAY
  BANK_TRANSFER
  CASH
}
enum SystemStatus {
  ACTIVE
  MAINTENANCE
  CLOSED
}
enum HallType {
  STANDARD
  IMAX
  VIP
}
enum SeatType {
  STANDARD
  VIP
  COUPLE
}
enum MovieFormat {
  TWO_D
  THREE_D
  IMAX
}
enum AgeRating {
  P
  T13
  T16
  T18
}
// ====================== MODELS ======================
// NOTE: User management is now fully handled by Clerk
// User data (role, cinemaId, phone, etc.) is stored in Clerk's publicMetadata
// userId references throughout the schema are Clerk user IDs

model Movie {
  id          String    @id @default(uuid())
  title       String
  posterUrl   String?   @map("poster_url")
  trailerUrl  String?   @map("trailer_url")
  runtime     Int       
  releaseDate DateTime  @map("release_date") @db.Date
  ageRating   AgeRating @map("age_rating")
  
  genres      Genre[]   
  showtimes   Showtime[]
  @@map("movies")
}
model Genre {
  id     String  @id @default(uuid())
  name   String  @unique
  movies Movie[]
  @@map("genres")
}
model Cinema {
  id        String       @id @default(uuid())
  name      String
  address   String
  city      String
  status    SystemStatus @default(ACTIVE)
  
  // employees are managed in Clerk with cinemaId in publicMetadata
  halls       Hall[]
  showtimes   Showtime[]
  reviews     CinemaReview[]
  concessions Concession[]
  @@map("cinemas")
}
model Hall {
  id        String       @id @default(uuid())
  cinemaId  String       @map("cinema_id")
  name      String
  type      HallType     @default(STANDARD)
  capacity  Int
  status    SystemStatus @default(ACTIVE)
  
  cinema    Cinema   @relation(fields: [cinemaId], references: [id], onDelete: Cascade)
  seats     Seat[]
  showtimes Showtime[]
  @@map("halls")
}
model Seat {
  id         String   @id @default(uuid())
  hallId     String   @map("hall_id")
  rowLetter  String   @map("row_letter")
  seatNumber Int      @map("seat_number")
  type       SeatType @default(STANDARD)
  
  hall       Hall     @relation(fields: [hallId], references: [id], onDelete: Cascade)
  tickets    Ticket[]
  locks      SeatLock[] 
  @@unique([hallId, rowLetter, seatNumber])
  @@map("seats")
}
model Showtime {
  id        String      @id @default(uuid())
  movieId   String      @map("movie_id")
  cinemaId  String      @map("cinema_id")
  hallId    String      @map("hall_id")
  startTime DateTime    @map("start_time")
  endTime   DateTime    @map("end_time")
  format    MovieFormat
  
  // NOTE: Price removed from here. 
  // It is now managed dynamically in TicketPricing.
  movie     Movie   @relation(fields: [movieId], references: [id])
  cinema    Cinema  @relation(fields: [cinemaId], references: [id])
  hall      Hall    @relation(fields: [hallId], references: [id])
  pricing   TicketPricing[] // <--- ADDED: Price list for this show
  bookings  Booking[]
  tickets   Ticket[] 
  locks     SeatLock[] 
  @@map("showtimes")
}
// =========================================================
// NEW: TICKET PRICING (Flexible per Showtime)
// =========================================================
model TicketPricing {
  id         String   @id @default(uuid())
  showtimeId String   @map("showtime_id")
  seatType   SeatType @map("seat_type")
  price      Decimal  @db.Decimal(10, 2)
  showtime   Showtime @relation(fields: [showtimeId], references: [id], onDelete: Cascade)
  // Constraint: One price per SeatType per Showtime
  @@unique([showtimeId, seatType])
  @@map("ticket_pricing")
}
// =========================================================
// SEAT LOCK (Race Condition Handling)
// =========================================================
model SeatLock {
  id         String   @id @default(uuid())
  showtimeId String   @map("showtime_id")
  seatId     String   @map("seat_id")
  userId     String?  @map("user_id") // Clerk user ID
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  showtime   Showtime @relation(fields: [showtimeId], references: [id], onDelete: Cascade)
  seat       Seat     @relation(fields: [seatId], references: [id], onDelete: Cascade)
  @@unique([showtimeId, seatId]) 
  @@map("seat_locks")
}
model Booking {
  id            String        @id @default(uuid())
  bookingCode   String        @unique @map("booking_code")
  userId        String        @map("user_id") // Clerk user ID
  showtimeId    String        @map("showtime_id")
  finalAmount   Decimal       @map("final_amount") @db.Decimal(10, 2)
  status        BookingStatus @default(PENDING) 
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  expiresAt     DateTime?     @map("expires_at")  // When pending booking expires
  
  showtime  Showtime @relation(fields: [showtimeId], references: [id])
  tickets     Ticket[]
  concessions BookingConcession[]
  payment     Payment?
  @@map("bookings")

}
model Ticket {
  id         String   @id @default(uuid())
  bookingId  String   @map("booking_id")
  seatId     String   @map("seat_id")
  showtimeId String   @map("showtime_id") 
  
  // Stores the ACTUAL price paid at that moment (historical record)
  price      Decimal  @db.Decimal(10, 2) 
  
  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  seat     Seat     @relation(fields: [seatId], references: [id])
  showtime Showtime @relation(fields: [showtimeId], references: [id])
  @@unique([showtimeId, seatId]) 
  @@map("tickets")
}
model Concession {
  id       String             @id @default(uuid())
  cinemaId String?            @map("cinema_id") 
  name     String
  price    Decimal            @db.Decimal(10, 2)
  cinema   Cinema?            @relation(fields: [cinemaId], references: [id])
  items BookingConcession[]
  @@map("concessions")
}
model BookingConcession {
  id           String  @id @default(uuid())
  bookingId    String  @map("booking_id")
  concessionId String  @map("concession_id")
  quantity     Int
  totalPrice   Decimal @map("total_price") @db.Decimal(10, 2)
  booking    Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  concession Concession @relation(fields: [concessionId], references: [id])
  @@map("booking_concessions")
}
model CinemaReview {
  id        String   @id @default(uuid())
  cinemaId  String   @map("cinema_id")
  userId    String   @map("user_id") // Clerk user ID
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  cinema Cinema @relation(fields: [cinemaId], references: [id], onDelete: Cascade)
  @@unique([cinemaId, userId])
  @@map("cinema_reviews")
}

// =========================================================
// PAYMENT MODEL
// =========================================================
model Payment {
  id            String        @id @default(uuid())
  bookingId     String        @unique @map("booking_id")
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod @map("payment_method")
  status        PaymentStatus @default(PENDING)
  
  // VNPAY specific fields
  vnpTxnRef     String?       @map("vnp_txn_ref")      // Transaction reference (bookingCode)
  vnpTransactionNo String?    @map("vnp_transaction_no") // VNPAY transaction number
  vnpBankCode   String?       @map("vnp_bank_code")    // Bank code used
  vnpBankTranNo String?       @map("vnp_bank_tran_no") // Bank transaction number
  vnpPayDate    String?       @map("vnp_pay_date")     // Payment date from VNPAY
  vnpResponseCode String?     @map("vnp_response_code") // Response code from VNPAY
  
  paymentUrl    String?       @map("payment_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  completedAt   DateTime?     @map("completed_at")
  
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}
